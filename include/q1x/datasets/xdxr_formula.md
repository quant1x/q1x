# 🧮 除权除息复权因子计算说明

## 📌 背景介绍

在股票投资中，公司进行分红、送股、配股、缩股、行权等操作会改变股东权益结构。为了保持历史价格与当前价格的可比性，需要对历史价格进行调整，这个过程称为 **复权处理**。

复权的核心是根据每次除权事件生成一个 **线性变换因子**：

$$
P_{adj} = m \cdot P + a
$$

其中：
- $ P $：原始价格
- $ P_{adj} $：复权后价格
- $ m $：比例因子（乘法）
- $ a $：偏移因子（加法）

---

## 📘 参数说明（每10股单位）

| 字段名         | 含义                     | 单位       |
|----------------|--------------------------|------------|
| `FenHong`      | 每10股分红金额           | 元/10股    |
| `SongZhuanGu`  | 每10股送转股数           | 股/10股    |
| `PeiGu`        | 每10股配股数             | 股/10股    |
| `PeiGuJia`     | 配股价                   | 元/股      |
| `SuoGu`        | 每10股缩股数             | 股/10股    |
| `FenShu`       | 每10股权证份数（行权）   | 股/10股    |
| `XingQuanJia`  | 行权价                   | 元/股      |

---

## 📐 复权因子推导公式

### 1. 构造参数 A 和 B

$$
A = \frac{PeiGu \times PeiGuJia - FenHong + FenShu \times XingQuanJia}{10}
$$

$$
B = \frac{SongZhuanGu + PeiGu - SuoGu + FenShu}{10}
$$

> ✅ 此处新增了行权项 `FenShu × XingQuanJia`，表示行权带来的资金流入。

### 2. 计算统一复权因子

$$
m = \frac{1}{1 + B},\quad a = A \cdot m
$$

因此，最终复权价格为：

$$
P_{adj} = m \cdot P + a
$$

---

## 🔁 多事件叠加原理（仿射变换复合）

多个复权事件可以依次叠加，其本质是两个仿射变换的复合：

设：
- 第一次复权：$ P_1 = m_1 \cdot P + a_1 $
- 第二次复权：$ P_2 = m_2 \cdot P_1 + a_2 $

则复合复权为：

$$
P_2 = m_2 \cdot (m_1 \cdot P + a_1) + a_2 = (m_2 \cdot m_1) \cdot P + (m_2 \cdot a_1 + a_2)
$$

定义运算符 $ * $ 表示两个复权因子的叠加：

$$
(m_1, a_1) * (m_2, a_2) = (m_2 \cdot m_1,\ m_2 \cdot a_1 + a_2)
$$

---

## 🗓️ 时间顺序处理逻辑

所有除权事件按 **日期排序（升序）**，同一日期内的事件按照如下优先级排序：

| 类型编号 | 类型名称     | 优先级 |
|----------|--------------|--------|
| 1,13,14  | 分红类       | 1      |
| 6        | 行权类       | 2      |
| 2        | 配股类       | 3      |
| 3,4      | 送股/转增股本 | 4      |
| 5        | 缩股类       | 5      |

排序后，将同一天的所有事件合并为一个统一的复权因子。

---

## 🧠 示例演算（含行权）

### 示例数据

| Date       | Category | Name   | FenHong | PeiGuJia | SongZhuanGu | PeiGu | SuoGu | FenShu | XingQuanJia |
|------------|----------|--------|---------|----------|-------------|-------|-------|--------|-------------|
| 2024-07-01 | 6        | 行权   | 0.0     | 0.0      | 0.0         | 0.0   | 0.0   | 2.0    | 5.0         |

### 步骤一：构造 A 和 B

$$
A = \frac{0 + 2.0 \cdot 5.0}{10} = 1.0
$$

$$
B = \frac{0 + 0 - 0 + 2.0}{10} = 0.2
$$

### 步骤二：计算 m 和 a

$$
m = \frac{1}{1 + 0.2} = 0.8333...
$$

$$
a = 1.0 \cdot 0.8333... = 0.8333...
$$

### 最终复权因子

$$
P_{adj} = 0.8333 \cdot P + 0.8333
$$

---

## 📦 批量价格应用函数

```cpp
void ApplyVectorized(const f64* in, f64* out, size_t count) const {
    for (size_t i = 0; i < count; ++i) {
        out[i] = m * in[i] + a;
    }
}